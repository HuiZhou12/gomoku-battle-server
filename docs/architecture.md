

# 系统架构说明

本文档用于说明 **战术五子棋实时对战引擎** 的整体系统架构，
包括核心模块划分、通信模型、状态管理方式以及关键设计决策。

---

## 1. 设计目标

系统架构设计遵循以下核心目标：

- 支持高并发 WebSocket 实时通信
- 保证对战状态的服务端权威性与一致性
- 能够在弱网与异常断连场景下保持可恢复性
- 架构清晰，可扩展为分布式部署

---

## 2. 系统整体架构

### 2.1 架构概览

![image-20260117204159460](./images/2.png)

系统采用 **客户端 – Netty 服务端 – Redis 状态层** 的三层结构，
其中 Netty 服务端作为实时通信与业务逻辑的核心枢纽。

> 注：客户端与服务端之间通过 WebSocket 建立长连接，
> 所有对战逻辑由服务端统一裁决。

------

## 3. 通信模型

### 3.1 WebSocket 通信

- 客户端通过 WebSocket 与服务端保持长连接
- 使用 Protobuf 编码的二进制协议传输消息
- 所有客户端请求均通过 Netty EventLoop 进入业务处理流程

### 3.2 消息类型划分

主要消息类型包括：

- 连接与心跳（CONNECT / HEARTBEAT）
- 匹配与对战状态同步
- 落子指令与对局结果
- 异常与重连通知

消息格式统一由 Protobuf 描述，
避免 JSON 在高频通信下的冗余开销。

------

## 4. 线程模型设计

### 4.1 Reactor 线程模型

服务端基于 Netty 实现 **主从 Reactor 模型**：

- **Boss Group**
  - 负责接收连接请求
- **Worker Group**
  - 负责网络 IO 与协议解码
- **业务线程池**
  - 承载高并发下的鉴权、解析、计算，避免阻塞 EventLoop

该设计可有效避免 IO 线程被业务逻辑阻塞，并提升系统在高并发场景下的可预测性。

> 相关细节请移步到[Netty 线程模型说明](./netty-thread-model.md)

------

## 5. 状态管理与一致性

### 5.1 服务端权威模型

- 客户端仅提交操作请求
- 所有状态推进与胜负判定由服务端完成
- 客户端仅作为状态展示终端

### 5.2 FSM 状态机

对战流程通过有限状态机（FSM）建模，例如：

```text
WAITING → MATCHED → PLAYING → FINISHED
            ↑          ↓
        RECONNECT   DISCONNECT
```

FSM 状态用于：

- 限制非法操作
- 保证状态推进的唯一性
- 简化异常处理逻辑

------

## 6. Redis 在架构中的角色

Redis 在系统中主要承担以下职责：

- 在线用户与连接状态管理
- 对战房间状态缓存
- 超时与断线判负逻辑（延迟队列）

Redis 作为共享状态层，使系统具备横向扩展的基础。

------

## 7. 异常与弱网处理策略

系统针对以下异常场景进行了设计：

- 客户端异常断线
- 网络抖动与心跳丢失
- 客户端重连与状态恢复

通过心跳机制 + FSM + Redis TTL，系统能够在弱网条件下保持状态一致性与可恢复性。

------

## 8. 架构总结

该架构具备以下特点：

- 以 Netty 为核心的高并发实时通信能力
- 清晰的线程模型与职责边界
- 服务端权威状态与 FSM 保证逻辑正确性
- 支持并发、弱网与异常场景

该设计可作为实时对战类应用的基础架构，并可进一步扩展至分布式部署。
