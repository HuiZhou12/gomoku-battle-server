# 并发与性能测试：性能瓶颈分析与优化过程

本文档用于记录在并发与性能测试过程中发现的问题、定位思路以及对应的工程优化措施。
重点不在于展示“最终指标”，而在于说明系统在高并发场景下的真实行为以及问题分析过程。

---

## 1. 初始问题

在最初进行并发测试时（500 并发，登录 + WebSocket 握手），
系统表现出以下异常现象：

- 总耗时明显偏高（1000 次请求约 13～16 秒完成）
- 平均响应时间达到数秒级
- 最大响应时间可达 10 秒以上
- 在尚未发送任何 WebSocket 业务消息的情况下，系统已出现明显延迟

从业务复杂度角度分析：
- 登录逻辑已引入缓存机制
- WebSocket 握手阶段不涉及房间匹配或对局逻辑
- 单次请求路径理论上应为轻量操作

因此初步判断：
> **性能问题并非来源于业务逻辑复杂度，而是连接生命周期或并发处理模型存在异常放大。**

---

## 2. 异常路径放大问题（NPE / ClosedChannel）

在并发测试过程中，服务端日志中出现大量异常，包括但不限于：

- `NullPointerException`（channelInactive 阶段）
- `StacklessClosedChannelException`
- `SocketException: Connection reset`

进一步分析发现：

- 在高并发场景下，部分连接在尚未完成 WebSocket 握手或鉴权前即被客户端关闭
- 服务端在 `channelInactive` 回调中假设所有连接均已完成用户上下文绑定
- 当 Channel 尚未绑定 `userId` 即触发关闭时，访问 Channel Attribute 导致 NPE

该问题带来的影响不仅是功能性错误，更严重的是：

- 每次异常都会触发异常构造与栈信息生成
- 异常日志在高并发下形成“异常风暴”
- 异常处理本身成为主要性能开销来源

### 修复措施

- 对 `channelInactive` 中的用户上下文访问增加空值判定
- 将“未完成鉴权即断开的连接”视为正常路径而非异常路径
- 对 `ClosedChannelException` 等非业务异常进行降级处理或忽略

修复后：
- 异常日志数量显著下降
- 错误率降至 0%
- 系统进入可预测的稳定运行状态

---

## 3. EventLoop 阻塞定位

在异常路径问题修复后，系统整体稳定性有所提升，
但在高并发瞬时建连场景下，响应时间仍然偏高。

通过对 Netty 线程模型与 Handler 执行位置的分析，发现：

- WebSocket 握手阶段的鉴权逻辑运行在 Netty EventLoop 线程中
- 鉴权逻辑中包含：
  - JWT 解析（CPU 密集）
  - URI 解析与参数处理
  - Channel Attribute 设置与 Pipeline 修改
- 在高并发场景下，EventLoop 线程被上述逻辑串行占用

该问题导致：
- EventLoop 无法及时处理新的 IO 事件
- WebSocket 握手请求在 EventLoop 队列中排队
- 响应时间被放大为秒级

### 定位结论

> **EventLoop 线程被用于执行不应在 IO 线程中完成的业务逻辑。**

---

## 4. 线程模型调整与验证

针对 EventLoop 阻塞问题，进行了线程模型调整：

- 将 WebSocket 鉴权 Handler 从默认 EventLoop 中移出
- 使用独立的 `DefaultEventExecutorGroup` 承载鉴权逻辑
- 明确区分：
  - IO 线程：仅负责协议解析与事件分发
  - 业务线程：负责鉴权与上下文初始化

调整后再次进行并发测试，观察到：

- EventLoop 线程负载显著下降
- 异常与阻塞现象消失
- 系统吞吐与响应时间曲线趋于稳定

该阶段确认：
> **线程模型设计正确，系统未再出现因线程使用不当导致的性能异常。**

---

## 5. 环境瓶颈确认（Windows / 单机）

在完成上述逻辑与线程模型优化后，系统表现稳定，
但在高并发瞬时建连场景下，整体吞吐仍然未随线程数线性提升。

结合测试环境与系统行为，最终确认性能瓶颈主要来源于：

- 单机环境下 TCP 三次握手与端口资源限制
- Windows 操作系统对高并发短连接的天然限制
- 客户端与服务端部署在同一台机器，导致 CPU / 网络资源竞争
- WebSocket 握手本身包含 HTTP Upgrade 开销

该阶段的性能表现呈现出：

- 吞吐稳定但不线性增长
- 响应时间呈现排队特征
- 系统无异常、无错误率，但受限于环境能力

### 工程判断

> **当前性能瓶颈属于环境与测试模型层面，而非系统架构或实现缺陷。**

在分布式部署或 Linux 环境下，预计系统具备进一步扩展空间。

---

## 6. 总结

通过多轮并发测试与问题定位，可以得出以下结论：

- 系统在高并发 WebSocket 场景下具备稳定运行能力
- 已消除异常路径放大与 EventLoop 阻塞等设计缺陷
- 当前性能瓶颈清晰可解释，且不来源于业务逻辑错误
- 系统具备进一步扩展与优化的工程基础