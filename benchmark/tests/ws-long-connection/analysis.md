# 并发与性能测试：**长连接稳定性分析与验证过程**

本文档用于记录在 **WebSocket 长连接稳态运行测试** 过程中，
系统在持续并发连接与周期性心跳场景下的行为表现、性能特征以及工程分析结论。

本阶段测试重点不在于连接建立速度，
而在于系统在**持续在线、高并发连接数量下的稳定性、可扩展性与资源控制能力**。

------

## 1. 测试背景与切换动机

在完成登录与 WebSocket 握手阶段的性能分析与优化后，
系统在高并发短连接场景下已达到稳定、可预测的运行状态。

然而，对于实时对战类系统而言，
**连接建立仅是入口阶段，系统的核心压力长期存在于“连接存活期”**，
包括但不限于：

- 大量 WebSocket 长连接同时在线
- 周期性心跳消息的持续处理
- 在线状态维护与掉线检测
- 连接生命周期管理与资源释放

因此测试目标从“建连性能”切换为：

> **验证系统在高并发 WebSocket 长连接稳态运行下的可靠性与扩展性。**

------

## 2. 测试模型设计（长连接）

### 2.1 并发模型

- 并发连接数：`500 / 800`
- 连接建立方式：预生成 Token，匀速建连
- 连接行为：保持 WebSocket 长连接
- 心跳机制：周期性发送 Protobuf 心跳包（Binary Frame）
- 运行时长：持续运行约 30 分钟

### 2.2 单连接执行行为

每个 WebSocket 长连接在建立完成后：

1. 定期发送心跳包（用于续命与在线检测）
2. 不主动断开连接
3. 不发送复杂业务消息（仅验证基础通信与连接管理）

该模型用于模拟真实线上场景中：
**大量玩家处于“在线但低频交互”的稳态阶段**。

------

## 3. 稳态运行表现观察

在 500 与 800 条 WebSocket 长连接的持续运行测试中，
系统表现出如下特征：

- 在线连接数始终稳定维持在目标值附近
- 未出现连接数量持续下降或异常增长
- 心跳处理吞吐在长时间运行过程中保持稳定
- 错误率始终为 0%，未出现异常断连或协议错误

该结果表明：

> **系统在长连接场景下未出现明显的资源泄漏或生命周期管理缺陷。**

------

## 4. 吞吐与扩展性分析

### 4.1 心跳吞吐对比

在不同并发连接规模下，系统心跳处理吞吐表现如下：

| 并发连接数 | 心跳吞吐（req/s） |
| ---------- | ----------------- |
| 500        | ~166              |
| 800        | ~266              |

通过计算可得：

- 单连接心跳处理速率保持一致
- 系统总体吞吐随连接数近似线性增长

该现象说明：

- 心跳处理逻辑未形成集中热点
- Channel 管理与心跳分发路径为 O(1) 复杂度
- Netty IO 线程与业务处理线程未出现争用或饱和

### 4.2 延迟特征

- 平均处理延迟保持在毫秒级
- 最大延迟稳定在亚秒级范围
- 未观察到延迟随运行时间增长的趋势

表明：

> **系统在稳态运行下不存在延迟累积或隐性阻塞问题。**

------

## 5. 连接管理模型验证

当前系统采用如下连接管理结构：

- 使用 `ConcurrentHashMap` 维护在线 Channel 映射
- 在压测模式下，通过逻辑唯一用户标识避免连接覆盖
- Channel 生命周期与用户在线态严格绑定

在长时间运行测试中验证：

- 连接建立与移除逻辑正确
- 未出现 Channel 未释放或映射残留
- 在线状态与心跳续命逻辑一致

该阶段确认：

> **连接管理模型在高并发长连接场景下具备工程可行性。**

------

## 6. 环境与瓶颈再确认

在长连接稳态运行测试中，系统未出现以下情况：

- CPU 使用率持续攀升
- JVM 内存单调增长
- Redis 在线态 Key 数量漂移
- 吞吐随时间下降

结合测试环境（单机 Windows、本机回环网络），
可以判断：

- 当前测试已脱离“连接建立瓶颈”阶段
- 系统主要受限于心跳频率与连接数量本身
- 性能表现已反映真实架构能力，而非测试噪声

------

## 7. 工程结论

通过对 WebSocket 长连接场景的持续并发测试，可以得出以下工程结论：

- 系统在 500 与 800 条 WebSocket 长连接下可稳定运行超过 30 分钟
- 心跳处理吞吐随连接数线性扩展，未出现性能拐点
- 未发现连接泄漏、异常断连或资源异常增长
- 当前架构设计适用于实时对战类应用的稳态运行需求

------

## 8. 总结

长连接测试阶段验证了系统在“持续在线”场景下的核心能力，
补全了并发性能验证从 **“入口阶段”** 到 **“稳态阶段”** 的完整证据链。

结合前期的登录与握手阶段测试，可以确认：

> **系统在高并发 WebSocket 场景下具备从连接建立到长期运行的完整稳定性保障。**

该结果为后续引入更复杂业务消息、分布式部署与线上容量评估提供了可靠基础。